<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formul√°rio com Mapa e Geolocaliza√ß√£o</title>

    <!-- Link para o Leaflet (Biblioteca para OpenStreetMap) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <script>
        let mapa;

        function obterLocalizacao() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function (posicao) {
                        let latitude = posicao.coords.latitude;
                        let longitude = posicao.coords.longitude;

                        document.getElementById("latitude").value = latitude;
                        document.getElementById("longitude").value = longitude;

                        let coordenadas = { lat: latitude, lng: longitude };

                        if (!mapa) {
                            mapa = L.map('mapa').setView(coordenadas, 15);
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                            }).addTo(mapa);
                        } else {
                            mapa.setView(coordenadas, 15);
                        }

                        L.marker(coordenadas).addTo(mapa)
                            .bindPopup('Voc√™ est√° aqui!')
                            .openPopup();
                    },
                    function (erro) {
                        alert("Erro ao obter localiza√ß√£o: " + erro.message);
                    }
                );
            } else {
                alert("Geolocaliza√ß√£o n√£o suportada pelo seu navegador.");
            }
        }

        async function converterImagemParaBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]); // Pega apenas os dados (remove "data:image/png;base64,")
                reader.onerror = error => reject(error);
            });
        }

        async function enviarFormulario(event) {
            event.preventDefault(); // Evita recarregar a p√°gina

            const nome = document.getElementById("nome").value;
            const cidade = document.getElementById("cidade").value;
            const estado = document.getElementById("estado").value;
            const pais = document.getElementById("pais").value;
            const cpf = document.getElementById("cpf").value;
            const latitude = document.getElementById("latitude").value;
            const longitude = document.getElementById("longitude").value;
            const fotoInput = document.getElementById("foto");

            if (!fotoInput.files.length) {
                alert("Por favor, selecione uma imagem.");
                return;
            }

            const imagemBase64 = await converterImagemParaBase64(fotoInput.files[0]);

            // Criando objeto JSON com os dados
            const dados = {
                nome,
                cidade,
                estado,
                pais,
                cpf,
                latitude,
                longitude,
                imagem: imagemBase64 // A imagem convertida em Base64
            };

            try {
                const response = await fetch("https://prod-06.brazilsouth.logic.azure.com:443/workflows/8cc5846e620641f9bb39c05ab2968dd7/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=mcF2zIlDHZJNSPWHkO1LQer1ay1YMB17SeSzOQOqSRU", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(dados) // Convertendo para JSON
                });

                if (response.ok) {
                    alert("‚úÖ Dados enviados com sucesso!");
                } else {
                    const erroTexto = await response.text();
                    alert("‚ùå Erro ao enviar os dados: " + erroTexto);
                }
            } catch (error) {
                alert("‚ùå Erro: " + error.message);
            }
        }
    </script>
</head>
<body>
    <h2>Formul√°rio de Registro</h2>

    <form id="meuFormulario">
        <label for="nome">Nome:</label>
        <input type="text" id="nome" required><br><br>

        <label for="cidade">Cidade:</label>
        <input type="text" id="cidade" required><br><br>

        <label for="estado">Estado:</label>
        <input type="text" id="estado" required><br><br>

        <label for="pais">Pa√≠s:</label>
        <input type="text" id="pais" required><br><br>

        <label for="cpf">CPF:</label>
        <input type="text" id="cpf" required><br><br>

        <label for="latitude">Latitude:</label>
        <input type="text" id="latitude" readonly><br><br>

        <label for="longitude">Longitude:</label>
        <input type="text" id="longitude" readonly><br><br>

        <label for="foto">Anexar Foto:</label>
        <input type="file" id="foto" accept="image/*" required><br><br>

        <button type="button" onclick="obterLocalizacao()">üìç Obter Localiza√ß√£o</button>
        <button type="submit">üì§ Enviar</button>
    </form>

    <h3>Mapa:</h3>
    <div id="mapa" style="width: 100%; height: 400px;"></div>

    <script>
        document.getElementById("meuFormulario").addEventListener("submit", enviarFormulario);
    </script>
</body>
</html>